<!-- chat.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alo • Between Sessions</title>
  <meta name="theme-color" content="#8B9A7D" />

  <!-- Inter (optional, falls back to system-ui) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --cream:#FDFBF7;
      --warm:#FAF8F5;
      --sage:#8B9A7D;
      --stone:#9C9589;
      --char:#2D2A26;

      --card: rgba(250,248,245,.85);
      --border: rgba(45,42,38,.12);
      --shadow: 0 18px 50px rgba(45,42,38,.10);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--char);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(139,154,125,.20), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(156,149,137,.18), transparent 55%),
        linear-gradient(180deg, var(--cream), var(--warm));
    }

    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding: clamp(14px, 2.5vw, 28px);
      gap: 14px;
    }

    header{
      width:min(980px, 100%);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 6px 2px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(139,154,125,.95), rgba(156,149,137,.75));
      box-shadow: 0 10px 30px rgba(45,42,38,.12);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:10px;
      border: 1.5px solid rgba(253,251,247,.85);
      background: rgba(253,251,247,.12);
    }
    .title h1{
      margin:0;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: .2px;
    }
    .title p{
      margin:3px 0 0;
      font-size: 13px;
      color: rgba(45,42,38,.70);
      max-width: 52ch;
      line-height: 1.35;
    }

    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(253,251,247,.60);
      border: 1px solid var(--border);
      font-size: 12px;
      color: rgba(45,42,38,.72);
      backdrop-filter: blur(6px);
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--sage);
      box-shadow: 0 0 0 3px rgba(139,154,125,.15);
    }
    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: rgba(253,251,247,.72);
      color: rgba(45,42,38,.78);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
      backdrop-filter: blur(6px);
    }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{ background: rgba(253,251,247,.90); }

    main{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      flex:1;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(45,42,38,.08);
    }
    .cardTop .left strong{
      font-size: 13px;
      font-weight: 600;
    }
    .cardTop .left div{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(45,42,38,.70);
      line-height: 1.35;
      max-width: 70ch;
    }

    .frameWrap{
      position:relative;
      width:100%;
      height: min(70vh, 740px);
      min-height: 520px;
      background: rgba(253,251,247,.55);
    }

    iframe{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
    }

    .footerHint{
      width:min(980px, 100%);
      font-size: 12px;
      color: rgba(45,42,38,.62);
      line-height: 1.45;
      padding: 0 2px 12px;
    }

    .srOnly{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    @media (max-width: 560px){
      header{ flex-direction:column; align-items:stretch; }
      .meta{ justify-content:flex-start; }
      .frameWrap{ min-height: 560px; height: 74vh; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>Alo</h1>
          <p>Your between-sessions companion — a steady place to think out loud, gently and privately.</p>
        </div>
      </div>

      <div class="meta">
        <span class="pill" title="Anonymous device identifier">
          <span class="dot" aria-hidden="true"></span>
          <span id="userIdLabel">user_id: …</span>
        </span>
        <button class="btn" id="copyBtn" type="button">Copy user_id</button>
        <button class="btn" id="resetBtn" type="button" title="Creates a new anonymous ID on this device">
          Reset ID
        </button>
      </div>
    </header>

    <main>
      <section class="card" aria-label="Chat with Alo">
        <div class="cardTop">
          <div class="left">
            <strong>Take a breath. Start anywhere.</strong>
            <div>
              This chat is anonymous by default. Your therapist may review session history using your <em>user_id</em>.
              If you’d rather keep a separate thread, use “Reset ID”.
            </div>
          </div>
        </div>

        <div class="frameWrap">
          <p class="srOnly" id="frameDesc">Embedded Botpress webchat iframe.</p>
          <iframe id="bpFrame" title="Alo chat" aria-describedby="frameDesc" loading="eager"></iframe>
        </div>
      </section>
    </main>

    <div class="footerHint">
      <strong>Privacy note:</strong> This page stores a random identifier in your browser (localStorage) so your chat thread stays consistent on this device.
      Clearing site data or using a different device will create a different thread.
    </div>
  </div>

  <script>
    // --- Config ---
    const BOT_ID = "fc0fad71-daea-4d22-adf5-3a659042d46a";
    const SHAREABLE_BASE = "https://cdn.botpress.cloud/webchat/v2.2/shareable.html";
    const STORAGE_KEY = "alo_user_id";

    // --- Helpers ---
    function getOrCreateUserId() {
      let id = localStorage.getItem(STORAGE_KEY);
      if (!id) {
        // crypto.randomUUID is supported in modern browsers, including GitHub Pages contexts.
        id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : fallbackUUID();
        localStorage.setItem(STORAGE_KEY, id);
      }
      return id;
    }

    function fallbackUUID() {
      // RFC4122-ish v4 fallback (good enough for an anonymous client id)
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
        const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 15);
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
      });
    }

    function setIframeSrc(userId) {
      const src = `${SHAREABLE_BASE}?botId=${encodeURIComponent(BOT_ID)}&userId=${encodeURIComponent(userId)}`;
      document.getElementById("bpFrame").src = src;
    }

    function setUserIdLabel(userId) {
      const short = userId.slice(0, 8) + "…" + userId.slice(-4);
      document.getElementById("userIdLabel").textContent = `user_id: ${short}`;
      document.getElementById("userIdLabel").setAttribute("data-full", userId);
    }

    async function copyUserId() {
      const userId = localStorage.getItem(STORAGE_KEY);
      try {
        await navigator.clipboard.writeText(userId);
        flashButton("copyBtn", "Copied");
      } catch {
        // fallback: prompt
        window.prompt("Copy your user_id:", userId);
      }
    }

    function flashButton(id, text) {
      const btn = document.getElementById(id);
      const prev = btn.textContent;
      btn.textContent = text;
      btn.disabled = true;
      setTimeout(() => {
        btn.textContent = prev;
        btn.disabled = false;
      }, 900);
    }

    function resetId() {
      localStorage.removeItem(STORAGE_KEY);
      const newId = getOrCreateUserId();
      setUserIdLabel(newId);
      setIframeSrc(newId);
    }

    // --- Init ---
    const userId = getOrCreateUserId();
    setUserIdLabel(userId);
    setIframeSrc(userId);

    document.getElementById("copyBtn").addEventListener("click", copyUserId);
    document.getElementById("resetBtn").addEventListener("click", resetId);
  </script>
</body>
</html>
